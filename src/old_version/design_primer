import os

#snakefile for design of primers
configfile: "./config_primer_design.json"

ds=config["degenerecies"].split(",")
ls=config["primer_sizes"].split(",")
dimer_cutoffs=config["dimer_cutoffs"].split(",")

rule all:
  input: expand("Results/List_{suffix}.txt", suffix=config["file_suffix_name"])

rule gff_file:
  input: config["tar_gff_files"]
  output: config["gff_file"]
  params: n=config["NCBI_gene_name"], t=os.path.join(config["work_dir"], "temporal_gff")
  message: "extracting positions from annotation file"
  shell: '''
          tar -xvf {input} -C {params.t}
          ls {params.t}/*.gz | while read file; do lines=$(gunzip -cd $file | grep "{params.n}" | grep "CDS"); echo -e "$file\t$lines" >> {ouput}; done
         '''

rule gene_sequences:
  input: gff=config["gff_file"], g=config["tar_file_genomes"]
  output: os.path.join(config["work_dir"], "gene_sequences", config["file_suffix_name"]+".fna")
  params: os.path.join(config["work_dir"], "temporal_genomes")
  message: "Extracting gene sequences from genomes"
  shell:  '''
              tar -xvf {input.g} -C {params}
              python src/from_refseq_gff_to_fasta.py -i {input.gff} -d {params} -o {output}
          '''
rule msa:
  input: os.path.join(config["work_dir"], config["file_suffix_name"]+".fna")
  output: os.path.join(config["work_dir"], "MSA", "_".join(["MSA_", config["file_suffix_name"]]))
  params: config["muscle_params"]
  message: "Multiple sequence alignment"
  shell: "muscle -in {input} -out {output} {params}"

rule degeprime_trim:
  input: os.path.join(config["work_dir"], "MSA", "_".join(["MSA_", config["file_suffix_name"]]))
  output: os.path.join(config["work_dir"], "MSA", "_".join(["trimmed_align_file_from_MSA", config["file_suffix_name"]]))
  params: config["trim_degeprime"]
  shell: "perl src/DEGEPRIME/TrimAlignment.pl -i {input} {params} -o {output}"

rule multidegeprime:
  input: os.path.join(config["work_dir"], "MSA", "_".join(["trimmed_align_file_from_MSA", config["file_suffix_name"]]))
  output: all=expand("degeprime_output/output_file_from_MSA_{suffix}_uniq_d{{d}}_l{{l}}", suffix=config["file_suffix_name"], d=ds, l=ls),
          sl=expand("degeprime_output/Selected/output_file_from_MSA_{suffix}_uniq_d{{d}}_l{{l}}_selected", suffix=config["file_suffix_name"], d=ds, l=ls)
  params: of=os.path.join(config["work_dir"], "degeprime_output", "output_file_from_MSA_"+config["file_suffix_name"]+"_uniq_d{d}_l{l}"),
          osf="output_file_from_MSA_"+config["file_suffix_name"]+"_uniq_d{d}_l{l}_selected",
          osd=os.path.join(config["work_dir"], "degeprime_output", "Selected"),
          log=os.path.join(config["work_dir"], "degeprime_output", "Log_files","output_file_from_MSA_"+config["file_suffix_name"]+"_uniq_d{d}_l{l}.log"),
          ds="{d}", ls="{l}"
  log: expand("degeprime_output/Log_files/output_file_from_MSA_{suffix}_uniq_d{{d}}_l{{l}}.log", suffix=config["file_suffix_name"], d=ds, l=ls)
  message: "DEGEPRIME -Finding primers per position -d {params.ds} -l {params.ls} "
  shell: '''
            perl src/DEGEPRIME/DegePrime.pl -i {input} -d {params.ds} -l {params.ls} -o {params.of} > {params.log}
            python src/parse_degeprime.py -i {params.of} -o {params.osf} -s d{params.ds}_l{params.ls} -d {params.osd}
         '''

rule primer_screen_list:
  input: expand("degeprime_output/Selected/output_file_from_MSA_{suffix}_uniq_d{d}_l{l}_selected", suffix=config["file_suffix_name"], d=ds, l=ls)
  output: expand("potential_primers/primers_{suffix}", suffix=config["file_suffix_name"])
  params: dir=config["work_dir"]+"/degeprime_output/Selected", p=config["primer_selection_parameters"]
  threads: 1
  message: "Selecting the best primer options after degeprime"
  shell: "python src/Primer_screen.py -d {params.dir} -o {output} {params.p}"

rule primer_screen_fasta:
  input: expand("potential_primers/primers_{suffix}", suffix=config["file_suffix_name"])
  output: expand("potential_primers/best_primers_pre_selection_{suffix}.fasta", suffix=config["file_suffix_name"])
  threads: 1
  message: "Printing out the best primer options after degeprime in fasta format"
  shell: "bash src/primer_sequences.sh {input} {output}"

rule mfe_hairpin:
  input: expand("potential_primers/best_primers_pre_selection_{suffix}.fasta", suffix=config["file_suffix_name"])
  output: expand("potential_primers/hairpin_best_primers_{suffix}", suffix=config["file_suffix_name"])
  message: "Checking hairpin"
  shell: "src/MFEprimer3/mfeprimer-3.2.2-linux-amd64 hairpin -i {input} -o {output}"

rule hairpin_screen:
  input: i=expand("potential_primers/hairpin_best_primers_{suffix}", suffix=config["file_suffix_name"]),
         f=expand("potential_primers/best_primers_pre_selection_{suffix}.fasta", suffix=config["file_suffix_name"])
  output: expand("potential_primers/primers_after_hairpin_screen_{suffix}.fasta", suffix=config["file_suffix_name"])
  message: "Filtering primers after hairpin calculation"
  shell: "python src/parse_mfeprimer.py -i {input.i} -f {input.f} -o {output} -t 0 -c Hairpin"

rule mfe_dimer1:
  input: expand("potential_primers/primers_after_hairpin_screen_{suffix}.fasta", suffix=config["file_suffix_name"])
  output: expand("potential_primers/dimer_best_primers_{suffix}", suffix=config["file_suffix_name"])
  message: "Dimer check 1 on pre_selected primers"
  shell: "src/MFEprimer3/mfeprimer-3.2.2-linux-amd64 dimer -i {input} -o {output}"

rule dimer_screen1:
  input: i=expand("potential_primers/dimer_best_primers_{suffix}", suffix=config["file_suffix_name"]),
         f=expand("potential_primers/primers_after_hairpin_screen_{suffix}.fasta", suffix=config["file_suffix_name"])
  output: expand("potential_primers/primers_after_dimer_{t}_screen_{suffix}.fasta", suffix=config["file_suffix_name"], t=dimer_cutoffs[0])
  params: dimer_cutoffs[0]
  message: "Filtering primers after dimer 1 calculation"
  shell: "python src/parse_mfeprimer.py -i {input.i} -f {input.f} -o {output} -t {params} -c Dimer"

rule mfe_dimer2:
  input: expand("potential_primers/primers_after_dimer_{t}_screen_{suffix}.fasta", suffix=config["file_suffix_name"], t=dimer_cutoffs[0])
  output: expand("potential_primers/pre_final_dimer_best_primers_{suffix}", suffix=config["file_suffix_name"])
  message: "Dimer check 2 on selected primers"
  shell: "src/MFEprimer3/mfeprimer-3.2.2-linux-amd64 dimer -i {input} -o {output}"

rule dimer_screen2:
  input: i=expand("potential_primers/pre_final_dimer_best_primers_{suffix}", suffix=config["file_suffix_name"]),
         f=expand("potential_primers/primers_after_dimer_{t}_screen_{suffix}.fasta", suffix=config["file_suffix_name"], t=dimer_cutoffs[0])
  output: expand("potential_primers/primers_after_dimer_{t2}_screen2_{suffix}.fasta", suffix=config["file_suffix_name"], t2=dimer_cutoffs[1])
  params: dimer_cutoffs[1]
  message: "Filtering primers after dimer 2 calculation"
  shell: "python src/parse_mfeprimer.py -i {input.i} -f {input.f} -o {output} -t {params} -c Dimer"

rule mfe_dimer3:
  input: expand("potential_primers/primers_after_dimer_{t2}_screen2_{suffix}.fasta", suffix=config["file_suffix_name"], t2=dimer_cutoffs[1])
  output: expand("potential_primers/final_dimer_best_primers_{suffix}", suffix=config["file_suffix_name"])
  message: "Final dimer check on selected primers"
  shell: "src/MFEprimer3/mfeprimer-3.2.2-linux-amd64 dimer -i {input} -o {output}"

rule dimer_screen3:
  input: i=expand("potential_primers/final_dimer_best_primers_{suffix}", suffix=config["file_suffix_name"]),
         f=expand("potential_primers/primers_after_dimer_{t2}_screen2_{suffix}.fasta", suffix=config["file_suffix_name"], t2=dimer_cutoffs[1])
  output: f=expand("Results/primers_{suffix}.fasta", suffix=config["file_suffix_name"]),
          t=expand("Results/primers_{suffix}_table", suffix=config["file_suffix_name"])
  params: dimer_cutoffs[2]
  message: "Printing out the selected primers in fasta format and table with primer characteristics (GC, TM, RevComp)"
  shell: "python src/parse_mfeprimer.py -i {input.i} -f {input.f} -o {output.f} -t {params} -c Dimer -p True"

rule list_primers:
  input: expand("Results/primers_{suffix}_table", suffix=config["file_suffix_name"])
  output: expand("Results/List_{suffix}.txt", suffix=config["file_suffix_name"])
  params: min=config["amplicon_size"].split(",")[0], max=config["amplicon_size"].split(",")[1], gene=config["NCBI_gene_name"]
  message: "Creating list_of_primers.txt"
  shell: "python src/create_list_of_primers.py -i {input} -o {output} -m {params.min} -M {params.max} -s {params.gene}"

rule clean:
  input: expand("potential_primers/primers_after_dimer_{t}_screen_{suffix}.fasta", suffix=config["file_suffix_name"], t=dimer_cutoffs[0]),
         expand("potential_primers/pre_final_dimer_best_primers_{suffix}", suffix=config["file_suffix_name"]),
         expand("potential_primers/primers_after_dimer_{t2}_screen2_{suffix}.fasta", suffix=config["file_suffix_name"], t2=dimer_cutoffs[1]),
         expand("potential_primers/final_dimer_best_primers_{suffix}", suffix=config["file_suffix_name"]),
         expand("Results/primers_{suffix}.fasta", suffix=config["file_suffix_name"]),
         expand("Results/primers_{suffix}_table", suffix=config["file_suffix_name"]),
         expand("Results/List_{suffix}.txt", suffix=config["file_suffix_name"])
  shell: " rm {input}"
